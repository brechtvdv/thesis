/*
 demo-optimization 2015-12-24 
*/
function CsvGenerator(a,b,c,d){this.dataArray=a,this.fileName=b,this.separator=c||",",this.addQuotes=!!d,this.addQuotes&&(this.separator='"'+this.separator+'"'),this.getDownloadLink=function(){var a=this.separator,b=this.addQuotes,c=this.dataArray.map(function(c){var d=c.join(a);return d.length&&b?'"'+d+'"':d}),d="data:text/csv;charset=utf-8",e=c.join("\n");return"function"==typeof btoa?(d+=";base64",e=btoa(e)):e=encodeURIComponent(e),this.downloadLink=this.downloadLink||d+","+e,this.downloadLink},this.getLinkElement=function(a){var b=this.getDownloadLink();return this.linkElement=this.linkElement||$("<a>"+(a||"")+"</a>",{href:b,download:this.fileName}),this.linkElement},this.download=function(a){this.getLinkElement().css("display","none").appendTo("body"),this.getLinkElement()[0].click(),a&&this.getLinkElement().remove()}}$(document).ready(function(){}),$(function(){$(".chosen-select").chosen(),$(".chosen-select-deselect").chosen({allow_single_deselect:!0});var a=L.icon({iconUrl:"../../images/leaf-green.png",shadowUrl:"../../images/leaf-shadow.png",iconSize:[38,95],shadowSize:[50,64],iconAnchor:[22,94],shadowAnchor:[4,62],popupAnchor:[-3,-76]}),b=L.map("map").setView([50.893,5.702],7),c=[],d=[];L.tileLayer("http://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(b);var e=function(e,f,g){var h=(new Date).getTime(),i=0,j=0,k=0;$(".amounttime").text("0");var l;l=g?new window.lc.OptimizedClient({entrypoints:["http://localhost:8080/"]}):new window.lc.Client({entrypoints:["http://localhost:8080/"]}),l.query({departureStop:e.toString(),arrivalStop:f.toString(),departureTime:new Date("2015-12-01T08:00"),arrivalStopLongitude:stops[f].loc.coordinates[0],arrivalStopLatitude:stops[f].loc.coordinates[1],departureStopLongitude:stops[e].loc.coordinates[0],departureStopLatitude:stops[e].loc.coordinates[1]},function(e,f){e.on("result",function(a){var b;b=a[0]["gtfs:trip"]?a[0]["gtfs:trip"]["@id"]:a[0].trip["@id"],$(".resulttable").find("tbody:last").append('<tr><th scope="row">Vertrekdatum: '+a[0].departureTime.getFullYear()+"-"+(a[0].departureTime.getMonth()+1).toString()+"-"+a[0].departureTime.getDate()+"</th></tr>"),$.each(a,function(c,d){var e;e=a[0]["gtfs:trip"]?a[0]["gtfs:trip"]["@id"]:a[0].trip["@id"],e!=b&&($(".resulttable").find("tbody:last").append('<tr style="color: blue;"><th scope="row" class="list-group-item-info">OVERSTAP</th></tr>'),b=e),stops[d.departureStop]&&stops[d.arrivalStop]?$(".resulttable").find("tbody:last").append('<tr><th scope="row">'+stops[d.departureStop].stop_name+"</th><td>"+("0"+d.departureTime.getHours()).slice(-2)+":"+("0"+d.departureTime.getMinutes()).slice(-2)+"</td><td>"+stops[d.arrivalStop].stop_name+"</td><td>"+("0"+d.arrivalTime.getHours()).slice(-2)+":"+("0"+d.arrivalTime.getMinutes()).slice(-2)+"</td></tr>"):stops[d.departureStop]?$(".resulttable").find("tbody:last").append('<tr><th scope="row">'+stops[d.departureStop].stop_name+"</th><td>"+("0"+d.departureTime.getHours()).slice(-2)+":"+("0"+d.departureTime.getMinutes()).slice(-2)+"</td><td>"+d.arrivalStop+"</td><td>"+("0"+d.arrivalTime.getHours()).slice(-2)+":"+("0"+d.arrivalTime.getMinutes()).slice(-2)+"</td></tr>"):stops[d.arrivalStop]?$(".resulttable").find("tbody:last").append('<tr><th scope="row">'+d.departureStop+"</th><td>"+("0"+d.departureTime.getHours()).slice(-2)+":"+("0"+d.departureTime.getMinutes()).slice(-2)+"</td><td>"+stops[d.arrivalStop].stop_name+"</td><td>"+("0"+d.arrivalTime.getHours()).slice(-2)+":"+("0"+d.arrivalTime.getMinutes()).slice(-2)+"</td></tr>"):$(".resulttable").find("tbody:last").append('<tr><th scope="row">'+d.departureStop+"</th><td>"+("0"+d.departureTime.getHours()).slice(-2)+":"+("0"+d.departureTime.getMinutes()).slice(-2)+"</td><td>"+d.arrivalStop+"</td><td>"+("0"+d.arrivalTime.getHours()).slice(-2)+":"+("0"+d.arrivalTime.getMinutes()).slice(-2)+"</td></tr>")})}),e.on("departureStop",function(d){var e=d.stopId,f=stops[e],g=L.marker([f.loc.coordinates[1],f.loc.coordinates[0]],{icon:a}).addTo(b).bindPopup("Stop ID: "+e+"\nPriority: "+d.priority+"\nName: "+f.stop_name+"\nLatitude: "+f.loc.coordinates[0]+"\nLongitude: "+f.loc.coordinates[1]);c.push(g)}),e.on("data",function(a){k++,$(".mobconnections").text(k);var c=stops[a.arrivalStop],e=stops[a.departureStop];if("undefined"!=typeof c&&"undefined"!=typeof e){var f=new L.LatLng(e.loc.coordinates[1],e.loc.coordinates[0]),g=new L.LatLng(c.loc.coordinates[1],c.loc.coordinates[0]),h=new L.Polyline([f,g],{color:"#3b6790",weight:6,smoothFactor:4});d.push(h),h.addTo(b)}}),e.on("error",function(a){console.error(a)}),f.on("request",function(a){console.log("Request sent to "+a),i++,$(".amountrequests").text(i)}),f.on("data",function(){j++,$(".totalamountconnections").text(j);var a=(new Date).getTime(),b=a-h;$(".amounttime").text(b/1e3)}),e.on("end",function(){var a=(new Date).getTime(),b=a-h;$(".amounttime").text(b/1e3)})})},f=function(){for(var a=0;a<c.length;a++)b.removeLayer(c[a]);for(var e=0;e<d.length;e++)b.removeLayer(d[e]);c=[],d=[]},g=function(){$(".resulttable tbody tr").remove()};$("#zoek").on("click",function(){f(),g();var a=$(".stopvan option:selected").val(),d=$(".stopnaar option:selected").val();""===a&&(a="8200110"),""===d&&(d="8892205");var h=stops[a],i=stops[d],j=new L.geoJson(h.loc);c.push(j),j.addTo(b).bindPopup("Stop ID: "+a+"\nName: "+h.stop_name+"\nLatitude: "+h.loc.coordinates[0]+"\nLongitude: "+h.loc.coordinates[1]),j=L.geoJson(i.loc),c.push(j),j.addTo(b).bindPopup("Stop ID: "+d+"\nName: "+i.stop_name+"\nLatitude: "+i.loc.coordinates[0]+"\nLongitude: "+i.loc.coordinates[1]);var k,l=h.connection_stop_id,m=i.connection_stop_id;k="regular"==$("input[name='radioBtn']:checked").val()?!1:!0,e(l,m,k)})}),$(function(){var a=[],b=1,c=0,d=0,e=0,f=queriesNMBS.length,g=0,h=function(b,i,j,k,l){console.log("Benchmarking iteratie "+b+"/"+i);var m;m="regular"==$("input[name='radioBtn']:checked").val()?!1:!0,m?planner=new window.lc.OptimizedClient({entrypoints:["http://localhost:8080/"]}):planner=new window.lc.Client({entrypoints:["http://localhost:8080/"]});var n=0,o=0,p=0,q=(new Date).getTime(),r=l[k].departureStop.toString(),s=l[k].arrivalStop.toString();console.log(r),console.log(s),planner.query({departureStop:r,arrivalStop:s,departureTime:new Date("2015-12-01T07:00"),arrivalStopLongitude:stops[s].loc.coordinates[0],arrivalStopLatitude:stops[s].loc.coordinates[1],departureStopLongitude:stops[r].loc.coordinates[0],departureStopLatitude:stops[r].loc.coordinates[1]},function(m,r){m.on("result",function(m){var r=(new Date).getTime(),s=r-q,t=s/1e3;c+=t;var u=(m[m.length-1].arrivalTime.getTime()-m[0].departureTime.getTime())/6e4;if(t>2*j&&0!==j&&(t=j),j+=t,console.log(t),b==i){g++,console.log(g);var v=[l[k].departureStop,l[k].arrivalStop,o,p,n+1,j/i,m.length,u];if(a.push(v),k++,30>k)b=1,j=0,h(b,i,j,k,l);else{console.log("Klaar met benchmarking");var w=c/l.length;console.log("Totale tijd van queries: "+c),console.log("Totaal aantal queries uitgevoerd: "+g),console.log("Gemiddelde snelheid voor "+f+" queries is: "+w),console.log("Totaal aantal requests: "+d),console.log("Totaal aantal connecties: "+e)}}else b++,h(b,i,j,k,l)}),m.on("data",function(a){p++,e++}),m.on("error",function(a){}),r.on("request",function(){n++,d++}),r.on("data",function(){o++}),m.on("end",function(){f--,g--,b=1,j=0,h(b,i,j,k,l)})})};$("#queryNMBS").on("click",function(){a=[["start_stop_id","end_stop_id","scan","mob","request","tijd","stops","duur"]];var c=0,d=0,e=1;h(e,b,c,d,queriesNMBS)}),$("#download").on("click",function(){csvGenerator=new CsvGenerator(a,"basicCSA.csv"),csvGenerator.download(!0)})});