/*
 demo-optimization 2015-11-27 
*/
$(document).ready(function(){$.each(stops,function(a,b){$(".stopvan").append("<option value='"+a+"'>"+b.stop_name+"</option>")}),$(".stopvan").trigger("chosen:updated"),$.each(stops,function(a,b){$(".stopnaar").append("<option value='"+a+"'>"+b.stop_name+"</option>")}),$(".stopnaar").trigger("chosen:updated")}),$(function(){$(".chosen-select").chosen(),$(".chosen-select-deselect").chosen({allow_single_deselect:!0});var a=L.map("map").setView([50.893,5.702],7),b=[],c=[];L.tileLayer("http://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(a);var d=function(b,d){var e=(new Date).getTime(),f=0,g=0,h=0;$(".amounttime").text("0");var i=new window.lc.Client({entrypoints:["http://belgianrail.linkedconnections.org/"]});i.query({departureStop:b.toString(),arrivalStop:d.toString(),departureTime:new Date("2015-10-05T10:00")},function(b){b.on("result",function(a){var b=a[0]["gtfs:trip"]["@id"];$(".resulttable").find("tbody:last").append('<tr><th scope="row">Vertrekdatum: '+a[0].departureTime.getFullYear()+"-"+(a[0].departureTime.getMonth()+1).toString()+"-"+a[0].departureTime.getDate()+"</th></tr>"),$.each(a,function(a,c){c["gtfs:trip"]["@id"]!=b&&($(".resulttable").find("tbody:last").append('<tr style="color: blue;"><th scope="row" class="list-group-item-info">OVERSTAP</th></tr>'),b=c["gtfs:trip"]["@id"]),stops[c.departureStop]&&stops[c.arrivalStop]?$(".resulttable").find("tbody:last").append('<tr><th scope="row">'+stops[c.departureStop].stop_name+"</th><td>"+("0"+c.departureTime.getHours()).slice(-2)+":"+("0"+c.departureTime.getMinutes()).slice(-2)+"</td><td>"+stops[c.arrivalStop].stop_name+"</td><td>"+("0"+c.arrivalTime.getHours()).slice(-2)+":"+("0"+c.arrivalTime.getMinutes()).slice(-2)+"</td></tr>"):stops[c.departureStop]?$(".resulttable").find("tbody:last").append('<tr><th scope="row">'+stops[c.departureStop].stop_name+"</th><td>"+("0"+c.departureTime.getHours()).slice(-2)+":"+("0"+c.departureTime.getMinutes()).slice(-2)+"</td><td>"+c.arrivalStop+"</td><td>"+("0"+c.arrivalTime.getHours()).slice(-2)+":"+("0"+c.arrivalTime.getMinutes()).slice(-2)+"</td></tr>"):stops[c.arrivalStop]?$(".resulttable").find("tbody:last").append('<tr><th scope="row">'+c.departureStop+"</th><td>"+("0"+c.departureTime.getHours()).slice(-2)+":"+("0"+c.departureTime.getMinutes()).slice(-2)+"</td><td>"+stops[c.arrivalStop].stop_name+"</td><td>"+("0"+c.arrivalTime.getHours()).slice(-2)+":"+("0"+c.arrivalTime.getMinutes()).slice(-2)+"</td></tr>"):$(".resulttable").find("tbody:last").append('<tr><th scope="row">'+c.departureStop+"</th><td>"+("0"+c.departureTime.getHours()).slice(-2)+":"+("0"+c.departureTime.getMinutes()).slice(-2)+"</td><td>"+c.arrivalStop+"</td><td>"+("0"+c.arrivalTime.getHours()).slice(-2)+":"+("0"+c.arrivalTime.getMinutes()).slice(-2)+"</td></tr>")})}),b.on("data",function(b){h++,$(".mobconnections").text(h);var d=stops[b.arrivalStop],e=stops[b.departureStop];if("undefined"!=typeof d&&"undefined"!=typeof e){var f=new L.LatLng(e.loc.coordinates[1],e.loc.coordinates[0]),g=new L.LatLng(d.loc.coordinates[1],d.loc.coordinates[0]),i=new L.Polyline([f,g],{color:"#3b6790",weight:6,smoothFactor:4});c.push(i),i.addTo(a)}}),b.on("error",function(a){console.error(a)}),b.on("request",function(){f++,$(".amountrequests").text(f)}),b.on("scan",function(){g++,$(".totalamountconnections").text(g);var a=(new Date).getTime(),b=a-e;$(".amounttime").text(b/1e3)}),b.on("end",function(){var a=(new Date).getTime(),b=a-e;$(".amounttime").text(b/1e3),console.log("end of stream")})})},e=function(){for(var d=0;d<b.length;d++)a.removeLayer(b[d]);for(var e=0;e<c.length;e++)a.removeLayer(c[e]);b=[],c=[]},f=function(){$(".resulttable tbody tr").remove()};$("#zoek").on("click",function(){e(),f();var c=$(".stopvan option:selected").val(),g=$(".stopnaar option:selected").val();""===c&&(c="8400526"),""===g&&(g="8892007");var h=stops[c],i=stops[g],j=new L.geoJson(h.loc);b.push(j),j.addTo(a).bindPopup("Stop ID: "+c+"\nName: "+h.stop_name+"\nLatitude: "+h.loc.coordinates[0]+"\nLongitude: "+h.loc.coordinates[1]),j=L.geoJson(i.loc),b.push(j),j.addTo(a).bindPopup("Stop ID: "+g+"\nName: "+i.stop_name+"\nLatitude: "+i.loc.coordinates[0]+"\nLongitude: "+i.loc.coordinates[1]);var k=h.connection_stop_id,l=i.connection_stop_id;d(k,l)})});